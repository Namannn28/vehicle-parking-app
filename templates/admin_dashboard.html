<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      font-size: 14px;
    }
    canvas {
      max-height: 250px;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container-fluid justify-content-between">
    <span class="navbar-brand mb-0 h1"> Admin Dashboard</span>
    <div>
      <a href="/add_lot" class="btn btn-outline-light btn-sm me-2"> Add Lot</a>
      <a href="/view_users" class="btn btn-outline-info btn-sm me-2"> Users</a>
      <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
    </div>
  </div>
</nav>

<div class="container-fluid px-4" style="max-width: 1200px;">

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ messages[0] }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endif %}
  {% endwith %}

  <h5 class="mb-3"> Parking Lots Overview</h5>
  {% if lots %}
  <table class="table table-bordered table-sm">
    <thead class="table-dark">
      <tr>
        <th>Lot Name</th>
        <th>Location</th>
        <th>Price (‚Çπ/hr)</th>
        <th>Max Spots</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for lot in lots %}
      <tr>
        <td>{{ lot.name }}</td>
        <td>{{ lot.location }}</td>
        <td>{{ lot.price }}</td>
        <td>{{ lot.max_spots }}</td>
        <td>
          <a href="/admin/view_spots/{{ lot.id }}" class="btn btn-primary btn-sm">View Spots</a>
          <a href="/edit_lot/{{ lot.id }}" class="btn btn-secondary btn-sm"> Edit</a>
          <a href="/delete_lot/{{ lot.id }}" class="btn btn-danger btn-sm ms-2"
             onclick="return confirm('Delete only if all spots are free. Continue?')">üóëÔ∏è Delete</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No parking lots available yet.</p>
  {% endif %}

  <h5 class="mt-5 mb-3"> Spot Charts Per Lot</h5>
  <div class="row">
    {% for lot in lot_data %}
    <div class="col-md-4 col-lg-3 mb-4">
      <div class="card p-2 text-center">
        <h6>{{ lot.name }}</h6>
        <canvas 
          class="lot-chart" 
          id="chart{{ lot.id }}" 
          data-booked="{{ lot.booked }}" 
          data-free="{{ lot.free }}">
        </canvas>
      </div>
    </div>
    {% endfor %}
  </div>

</div>

<script>
window.onload = function () {
  document.querySelectorAll('.lot-chart').forEach(function(canvas) {
    const booked = Number(canvas.dataset.booked);
    const free = Number(canvas.dataset.free);
    const ctx = canvas.getContext("2d");

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Booked', 'Free'],
        datasets: [{
          data: [booked, free],
          backgroundColor: ['#dc3545', '#28a745']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 12 } }
          }
        }
      }
    });
  });
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
